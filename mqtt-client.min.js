var MqttClient=function(e){function n(){o.connected=!1,o.reconnect?setTimeout(function(){o.unbind("disconnect",n),o.connect()},o.reconnect):o.emitter.trigger("offline")}var t=Array.prototype.slice,i=function(e){return JSON.parse(JSON.stringify(e))},s=function(e,n,t,i){var s=new Paho.MQTT.Message(n);return s.destinationName=e,s.qos=Number(t)||0,s.retained=!!i,s},o=this;return o.connected=!1,o.broker=i({host:e.host,port:Number(e.port),clientId:e.clientId||"client-"+Math.random().toString(36).slice(-6)}),o.options=i({timeout:Number(e.timeout)||10,keepAliveInterval:Number(e.keepalive)||30,mqttVersion:e.mqttVersion||void 0,userName:e.username||void 0,password:e.password||void 0,useSSL:void 0!==e.ssl?e.ssl:!1,cleanSession:void 0!==e.clean?e.clean:!0,willMessage:e.will&&e.will.topic.length?e.will:void 0}),o.reconnect=e.reconnect,o.emitter={events:{},bind:function(e,n){return o.emitter.events[e]=o.emitter.events[e]||[],o.emitter.events[e].push(n),o},unbind:function(e,n){return e in o.emitter.events&&o.emitter.events[e].splice(o.emitter.events[e].indexOf(n),1),o},trigger:function(e){if(e in o.emitter.events)for(var n=0;n<o.emitter.events[e].length;++n)try{o.emitter.events[e][n].apply(o,t.call(arguments,1))}catch(e){setTimeout(function(){throw e})}}},o.on=o.emitter.bind,o.bind=o.emitter.bind,o.unbind=o.emitter.unbind,o.once=function(e,n){return o.on(e,function i(){n.apply(o,t.call(arguments)),o.unbind(e,i)}),o},o.convertTopic=function(e){return new RegExp("^"+e.replace(/\+/g,"[^/]+").replace(/#/g,".+")+"$")},o.messages={func:[],bind:function(e,n,t){return 2===arguments.length&&"function"==typeof n&&(t=n),t.topic=e,t.re=o.convertTopic(e),t.qos=Number(n)||0,o.messages.func.push(t),o},unbind:function(e){var n=o.messages.func.indexOf(e);return n>-1&&o.messages.func.splice(n,1),o},trigger:function(e){var n=t.call(arguments,1);o.messages.func.forEach(function(t){t.re.test(e)&&t.apply(o,n)})}},o.messages.on=o.messages.bind,o.on("message",o.messages.trigger),o.client=new Paho.MQTT.Client(o.broker.host,o.broker.port,o.broker.clientId),o.client.onConnectionLost=o.emitter.trigger.bind(o,"disconnect"),o.messageCache=[],o.client.onMessageDelivered=function(e){o.messageCache.indexOf(e)>=0&&o.messageCache.splice(o.messageCache.indexOf(e))[0].callback()},o.client.onMessageArrived=function(e){o.emitter.trigger("message",e.destinationName,e.payloadString||e.payloadBytes,{topic:e.destinationName,qos:e.qos,retained:e.retained,payload:e.payloadBytes,duplicate:e.duplicate})},o.connect=function(){o.once("connect",function(){o.connected=!0}),o.once("disconnect",n);var e=i(o.options);return e.onSuccess=o.emitter.trigger.bind(o,"connect"),e.onFailure=o.emitter.trigger.bind(o,"disconnect"),e.willMessage&&(e.willMessage=s(e.willMessage.topic,e.willMessage.payload,e.willMessage.qos,e.willMessage.retain)),o.client.connect(e),o.emitter.trigger("connecting"),o},o.disconnect=function(){o.unbind("disconnect",n),o.client.disconnect(),o.emitter.trigger("disconnect"),o.emitter.trigger("offline")},o.subscribe=function(e,n,t){2===arguments.length&&"function"==typeof arguments[1]&&(t=n),o.client.subscribe(e,t?{qos:Number(n)||0,timeout:15,onSuccess:function(e){t.call(o,void 0,e.grantedQos[0])},onFailure:t.bind(o)}:{})},o.unsubscribe=function(e,n){o.client.unsubscribe(e,n?{timeout:15,onSuccess:n.bind(o,void 0),onFailure:n.bind(o)}:{})},o.publish=function(e,n,t,i){var c=s(e,n,t&&t.qos,t&&t.retain);i&&(c.qos<1?setTimeout(i):(c.callback=i,o.messageCache.push(c))),o.client.send(c)},o};